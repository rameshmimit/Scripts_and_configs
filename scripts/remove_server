#!/bin/bash

if [ "$(id -u)" != "0" ]; then
   echo "This script must be run as root" 1>&2
   exit 1
fi

if [ -z "$1" ]; then
echo "You need at least 1 argument"
echo ""
echo "Usage: ./remove_server server_name"
echo ""
echo "eg: ./remove_server app18"
exit 1

else

mysql -e "use infra; select id from host where name='$1';" > /tmp/1 
id = `cat /tmp/1 | awk 'NR==2'`
mysql -e "use infra; delete from virtual_hosts where host_id=$id; delete from role where host_id=$id; delete from overlay_ip where host='$1'"
echo "Removed $1 from infra DB"

echo "Please enter your LDAP user name\n"
read ldapusername
echo "Please enter your LDAP password:\t"
read ldappass
/usr/bin/sshpass -p $ldappass ssh $ldapusername@$1 "sudo /etc/init.d/puppet stop"

/root/puppetstoredconfigclean.rb $1.sl.ss

/usr/bin/sshpass -p $ldappass ssh $ldapusername@monitor01 "mv /etc/nagios/objects/hosts.cfg  /tmp/; mv /etc/nagios/objects/autogenerated-alerts.cfg /tmp/; puppetd --test"

echo "Delete from the documentation \n"
echo "TIP: Do a quick search on the wiki with the server name."

echo "Deleting the records from DNS..."
# Switch to bs user
su - bs
/users/home/bs/make_dns
exit # Log out from the account

fi
